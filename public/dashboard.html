<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> 拽专 | 注专转 专砖 注住拽</title>
    <link rel="stylesheet" href="/tailwind.min.css">
</head>
<body class="bg-gray-100 min-h-screen flex flex-col" dir="rtl">

    <header class="bg-white shadow-md px-6 py-3 flex justify-between items-center">
        <h1 class="text-xl font-bold text-gray-800">注专转 专砖 注住拽 - 注爪 专转 </h1>
        <div class="flex items-center gap-4">
            <nav class="flex gap-3">
                <a href="dashboard.html" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors"> 拽专</a>
                <a href="inspection.html" class="px-4 py-2 bg-gray-100 border border-gray-300 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200 transition-colors">拽专转 砖</a>
            </nav>
            <span id="admin-link-placeholder"></span>
            <span id="user-name" class="text-gray-700 text-sm font-medium">砖, 砖转砖</span>
            <button onclick="logout()" class="px-4 py-2 bg-red-500 text-white rounded-lg text-sm font-medium hover:bg-red-600 transition-colors">爪</button>
        </div>
    </header>

    <div class="container mx-auto px-4 py-8 flex-1 w-full max-w-7xl" style="box-sizing:border-box;">

        <!-- Inspection Board Header -->
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800"> 拽专转 驻拽</h2>
            <div class="flex items-center gap-4">
                <button id="toggle-map-btn" onclick="toggleMap()"
                    class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                    </svg>
                    <span id="map-btn-text">驻砖 驻</span>
                </button>
                <div class="relative">
                    <input type="text" id="report-search" placeholder="驻砖 驻 砖 注住拽  驻拽..."
                        class="border border-gray-300 rounded-lg py-2 px-4 w-64 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                        oninput="filterReports()">
                </div>
            </div>
        </div>

        <!-- Map Section (hidden by default) -->
        <div id="map-section" class="hidden bg-white shadow-md rounded-lg overflow-hidden mb-8 p-6">
            <h3 class="text-lg font-semibold mb-4 text-gray-700">转专 住 驻 拽</h3>
            <div class="mb-4">
                <input id="map-search-input" type="text" placeholder="驻砖 转转..."
                    class="w-full p-2 border border-gray-300 rounded shadow-sm focus:ring-2 focus:ring-blue-500 text-sm">
            </div>
            <div id="dashboard-map" class="w-full rounded-lg shadow-md border border-gray-200" style="height:384px;"></div>
        </div>

        <!-- Calendar View -->
        <div class="bg-white shadow-md rounded-lg overflow-hidden mb-8 p-6">
            <div class="flex justify-between items-center mb-6">
                <button onclick="changeMonth(-1)" class="p-2 hover:bg-gray-100 rounded-full text-gray-600" title="砖 ">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
                <h3 id="calendar-title" class="text-xl font-bold text-gray-800"></h3>
                <div class="flex items-center gap-2">
                    <button onclick="changeMonth(1)" class="p-2 hover:bg-gray-100 rounded-full text-gray-600" title="砖 拽">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <button onclick="goToToday()"
                        class="px-3 py-1 text-sm font-medium text-blue-600 bg-blue-50 rounded-full hover:bg-blue-100 transition-colors">
                        
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-7 gap-2 text-center mb-2">
                <div class="font-bold text-gray-500 text-sm">'</div>
                <div class="font-bold text-gray-500 text-sm">'</div>
                <div class="font-bold text-gray-500 text-sm">'</div>
                <div class="font-bold text-gray-500 text-sm">'</div>
                <div class="font-bold text-gray-500 text-sm">'</div>
                <div class="font-bold text-gray-500 text-sm">'</div>
                <div class="font-bold text-gray-500 text-sm">砖'</div>
            </div>
            <div id="calendar-grid" class="grid grid-cols-7 gap-2">
                <!-- Calendar days rendered by JS -->
            </div>
        </div>

        <!-- Reports Table -->
        <div class="bg-white shadow-md rounded-lg overflow-hidden mb-8">
            <table class="min-w-full leading-normal">
                <thead>
                    <tr>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">转专 拽专</th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">砖 注住拽</th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">转转</th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">驻拽 专</th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">住住</th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">驻注转</th>
                    </tr>
                </thead>
                <tbody id="reports-tbody">
                    <tr><td colspan="6" class="px-5 py-5 text-center text-gray-500">注 "转...</td></tr>
                </tbody>
            </table>
            <div id="no-reports-msg" class="hidden p-5 text-center text-gray-500"> 爪 "转 转 转 驻砖</div>
        </div>

        <!-- Business List Card -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="flex justify-between items-center px-5 py-4 border-b border-gray-200 bg-gray-50">
                <h3 class="text-lg font-semibold text-gray-700">专砖转 注住拽</h3>
                <div class="flex items-center gap-3">
                    <input type="text" id="search-input" placeholder="驻砖 驻 砖 注住拽..."
                        class="border border-gray-300 rounded-lg py-2 px-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                        oninput="filterBusinesses()">
                    <a href="inspection.html"
                        class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 transition-colors">拽专转 注住拽 砖</a>
                </div>
            </div>
            <table id="business-table" class="min-w-full leading-normal">
                <thead>
                    <tr>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">砖 注住拽</th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">转转</th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">注</th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">驻专 专砖</th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">驻注转</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="5" class="px-5 py-5 text-center text-gray-500">注 转...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Report Details Modal -->
    <div id="report-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex justify-center items-center z-50">
        <div class="relative bg-white rounded-lg shadow-xl p-8 w-full max-w-2xl m-4" style="max-height:90vh;overflow-y:auto;">
            <button onclick="closeModal()" class="absolute top-4 left-4 text-gray-500 hover:text-gray-700">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <div id="modal-content"></div>
        </div>
    </div>

    <footer class="text-center py-4 bg-white border-t border-gray-200 text-gray-500 text-sm mt-auto">
        &copy; 2026 注专转 专砖 注住拽 - 注爪 专转.  转 砖专转.
    </footer>

    <script>
        // Load Google Maps API key from server (same approach as inspection.html)
        fetch('/api/config/google-maps')
            .then(function(response) { return response.json(); })
            .then(function(data) {
                var script = document.createElement('script');
                script.src = 'https://maps.googleapis.com/maps/api/js?key=' + data.key + '&libraries=places&loading=async';
                script.async = true;
                script.defer = true;
                document.head.appendChild(script);
            })
            .catch(function(err) { console.warn('Google Maps API not loaded:', err); });
    </script>

    <script>
        const token = localStorage.getItem('token');
        const userStr = localStorage.getItem('user');

        if (!token) window.location.href = 'login.html';

        if (userStr) {
            try {
                const user = JSON.parse(userStr);
                document.getElementById('user-name').textContent = '砖, ' + user.fullName;
                if (user.role === 'admin') {
                    const adminLink = document.createElement('a');
                    adminLink.href = 'admin-dashboard.html';
                    adminLink.textContent = '驻 ';
                    adminLink.className = 'text-blue-600 text-sm font-medium hover:underline';
                    document.getElementById('admin-link-placeholder').appendChild(adminLink);
                }
            } catch (e) { console.error(e); logout(); }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }

        var allReports = [];
        var filteredReports = [];
        var businessesData = [];
        var currentDate = new Date();
        var mapVisible = false;
        var dashboardMap = null;
        var dashboardGeocoder = null;

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('he-IL', {
                year: 'numeric', month: 'long', day: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        }

        function getStatusBadge(status) {
            var map = {
                'pass':    '<span class="px-2 py-1 text-xs font-semibold text-green-800 bg-green-100 rounded-full">注专 爪</span>',
                'fail':    '<span class="px-2 py-1 text-xs font-semibold text-red-800 bg-red-100 rounded-full">砖</span>',
                'warning': '<span class="px-2 py-1 text-xs font-semibold text-yellow-800 bg-yellow-100 rounded-full">专</span>'
            };
            return map[status] || '<span class="px-2 py-1 text-xs font-semibold text-gray-800 bg-gray-100 rounded-full">转</span>';
        }

        function getRiskLevelColor(level) {
            var map = { high: 'text-red-600', medium: 'text-yellow-600', low: 'text-green-600' };
            return map[(level || '').toLowerCase()] || 'text-gray-600';
        }

        async function fetchReports() {
            try {
                var res = await fetch('/api/reports', { headers: { 'Authorization': 'Bearer ' + token } });
                if (res.status === 401) { logout(); return; }
                if (!res.ok) throw new Error('Failed to fetch reports');
                allReports = await res.json();
                filteredReports = allReports.slice();
                filterReports();
                renderCalendar();
            } catch (err) {
                console.error('Error fetching reports:', err);
                document.getElementById('reports-tbody').innerHTML =
                    '<tr><td colspan="6" class="px-5 py-5 text-center text-red-500">砖 注转 "转</td></tr>';
                renderCalendar();
            }
        }

        function filterReports() {
            var search = document.getElementById('report-search').value.toLowerCase();
            var year = currentDate.getFullYear();
            var month = currentDate.getMonth();

            filteredReports = allReports.filter(function(r) {
                var d = new Date(r.visitDate);
                var sameMonth = d.getMonth() === month && d.getFullYear() === year;
                if (!sameMonth) return false;
                var biz = (r.Business && r.Business.businessName ? r.Business.businessName : '').toLowerCase();
                var inspector = (r.inspector && r.inspector.fullName ? r.inspector.fullName : '').toLowerCase();
                return biz.includes(search) || inspector.includes(search);
            });
            renderReportsTable();
        }

        function renderReportsTable() {
            var tbody = document.getElementById('reports-tbody');
            var noMsg = document.getElementById('no-reports-msg');

            if (filteredReports.length === 0) {
                tbody.innerHTML = '';
                noMsg.classList.remove('hidden');
                return;
            }
            noMsg.classList.add('hidden');

            tbody.innerHTML = filteredReports.map(function(r) {
                return '<tr class="hover:bg-gray-50">' +
                    '<td class="px-5 py-4 border-b border-gray-200 text-sm">' + formatDate(r.visitDate) + '</td>' +
                    '<td class="px-5 py-4 border-b border-gray-200 text-sm font-medium">' + (r.Business && r.Business.businessName ? r.Business.businessName : '-') + '</td>' +
                    '<td class="px-5 py-4 border-b border-gray-200 text-sm">' + (r.Business && r.Business.address ? r.Business.address : '-') + '</td>' +
                    '<td class="px-5 py-4 border-b border-gray-200 text-sm">' + (r.inspector && r.inspector.fullName ? r.inspector.fullName : '-') + '</td>' +
                    '<td class="px-5 py-4 border-b border-gray-200 text-sm text-center">' + getStatusBadge(r.status) + '</td>' +
                    '<td class="px-5 py-4 border-b border-gray-200 text-sm text-center">' +
                        '<button onclick="openReportModal(' + r.id + ')" class="text-blue-600 hover:text-blue-900 text-sm">爪驻 "</button>' +
                    '</td>' +
                '</tr>';
            }).join('');
        }

        function openReportModal(id) {
            var r = allReports.find(function(x) { return x.id === id; });
            if (!r) return;

            var aiHtml = '';
            if (r.aiRiskAssessment) {
                var ai = r.aiRiskAssessment;
                var recList = (ai.recommendations || []).map(function(rec) { return '<li>' + rec + '</li>'; }).join('');
                aiHtml = '<div class="mb-6 border-t pt-4">' +
                    '<h4 class="text-lg font-semibold mb-2 text-purple-700 flex items-center">' +
                    '<span class="ml-2"></span> 转 住 (AI)</h4>' +
                    '<div class="bg-purple-50 p-4 rounded-lg border border-purple-100">' +
                    '<div class="mb-2"><span class="font-bold">专转 住: </span>' +
                    '<span class="font-bold ' + getRiskLevelColor(ai.riskLevel) + '">' + ai.riskLevel + '</span></div>' +
                    '<p class="mb-3 text-gray-700">' + ai.summary + '</p>' +
                    (recList ? '<div><span class="font-bold block mb-1">爪转:</span><ul class="list-disc list-inside text-gray-700">' + recList + '</ul></div>' : '') +
                    '</div></div>';
            }

            var pdfBtn = r.pdfPath
                ? '<a href="' + r.pdfPath + '" target="_blank" rel="noopener noreferrer"' +
                  ' class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition text-sm">专 PDF</a>'
                : '';

            var bizName = r.Business && r.Business.businessName ? r.Business.businessName : '';
            var bizAddr = r.Business && r.Business.address ? r.Business.address : '-';
            var inspName = r.inspector && r.inspector.fullName ? r.inspector.fullName : '-';

            document.getElementById('modal-content').innerHTML =
                '<h2 class="text-2xl font-bold mb-4 text-gray-800">" 拽专转: ' + bizName + '</h2>' +
                '<div class="grid grid-cols-2 gap-4 mb-6">' +
                '<div><p class="text-sm text-gray-500">转专 拽专</p><p class="font-medium">' + formatDate(r.visitDate) + '</p></div>' +
                '<div><p class="text-sm text-gray-500">驻拽</p><p class="font-medium">' + inspName + '</p></div>' +
                '<div><p class="text-sm text-gray-500">住住</p><div class="mt-1">' + getStatusBadge(r.status) + '</div></div>' +
                '<div><p class="text-sm text-gray-500">转转</p><p class="font-medium">' + bizAddr + '</p></div>' +
                '</div>' +
                '<div class="mb-6">' +
                '<h4 class="text-lg font-semibold mb-2 text-gray-700">爪 拽专转</h4>' +
                '<p class="bg-gray-50 p-4 rounded-lg text-gray-700 whitespace-pre-wrap">' + (r.findings || ' 爪 专砖.') + '</p>' +
                '</div>' +
                aiHtml +
                '<div class="flex justify-end gap-3 mt-6">' +
                pdfBtn +
                '<button onclick="closeModal()" class="bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300 transition text-sm">住专</button>' +
                '</div>';

            document.getElementById('report-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('report-modal').classList.add('hidden');
        }

        document.getElementById('report-modal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        function renderCalendar() {
            var year = currentDate.getFullYear();
            var month = currentDate.getMonth();

            document.getElementById('calendar-title').textContent =
                currentDate.toLocaleDateString('he-IL', { month: 'long', year: 'numeric' });

            var daysInMonth = new Date(year, month + 1, 0).getDate();
            var firstDay = new Date(year, month, 1).getDay();

            var grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';

            for (var i = 0; i < firstDay; i++) {
                var empty = document.createElement('div');
                empty.className = 'h-24';
                grid.appendChild(empty);
            }

            var today = new Date();

            for (var day = 1; day <= daysInMonth; day++) {
                var dayReports = allReports.filter(function(r) {
                    var d = new Date(r.visitDate);
                    return d.getDate() === day && d.getMonth() === month && d.getFullYear() === year;
                });

                var isToday = today.getDate() === day && today.getMonth() === month && today.getFullYear() === year;

                var cell = document.createElement('div');
                cell.className = 'h-24 border rounded-lg p-2 flex flex-col items-start justify-between ' +
                    (isToday ? 'border-blue-400 bg-blue-50' : 'bg-gray-50 hover:bg-gray-100');

                var dots = dayReports.map(function(r) {
                    var color = r.status === 'pass' ? 'bg-green-500' : r.status === 'fail' ? 'bg-red-500' : 'bg-yellow-500';
                    var title = r.Business && r.Business.businessName ? r.Business.businessName : '';
                    return '<div class="w-2 h-2 rounded-full ' + color + '" title="' + title + '"></div>';
                }).join('');

                var countBadge = dayReports.length > 0
                    ? '<span class="text-xs text-gray-500 mr-auto">' + dayReports.length + '</span>'
                    : '';

                cell.innerHTML =
                    '<span class="font-semibold ' + (isToday ? 'text-blue-700' : 'text-gray-700') + ' text-sm">' + day + '</span>' +
                    '<div class="flex flex-wrap gap-1 w-full">' + dots + countBadge + '</div>';

                grid.appendChild(cell);
            }
        }

        function changeMonth(offset) {
            currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + offset, 1);
            filterReports();
            renderCalendar();
        }

        function goToToday() {
            currentDate = new Date();
            filterReports();
            renderCalendar();
        }

        function toggleMap() {
            mapVisible = !mapVisible;
            var section = document.getElementById('map-section');
            var btnText = document.getElementById('map-btn-text');
            if (mapVisible) {
                section.classList.remove('hidden');
                btnText.textContent = '住转专 驻';
                initDashboardMap();
            } else {
                section.classList.add('hidden');
                btnText.textContent = '驻砖 驻';
            }
        }

        function initDashboardMap() {
            if (dashboardMap) return;
            if (typeof google === 'undefined') {
                console.warn('Google Maps not loaded yet');
                return;
            }
            dashboardMap = new google.maps.Map(document.getElementById('dashboard-map'), {
                center: { lat: 31.6, lng: 34.8 },
                zoom: 11
            });
            dashboardGeocoder = new google.maps.Geocoder();

            var input = document.getElementById('map-search-input');
            var autocomplete = new google.maps.places.Autocomplete(input, {
                componentRestrictions: { country: 'il' }
            });
            autocomplete.addListener('place_changed', function() {
                var place = autocomplete.getPlace();
                if (!place.geometry) return;
                dashboardMap.setCenter(place.geometry.location);
                dashboardMap.setZoom(15);
                document.getElementById('report-search').value = place.formatted_address || '';
                filterReports();
            });

            addBusinessMarkers();
        }

        function addBusinessMarkers() {
            if (!dashboardMap || !dashboardGeocoder) return;
            businessesData.forEach(function(biz) {
                if (!biz.address) return;
                dashboardGeocoder.geocode({ address: biz.address }, function(results, status) {
                    if (status === 'OK' && results[0]) {
                        var marker = new google.maps.Marker({
                            map: dashboardMap,
                            position: results[0].geometry.location,
                            title: biz.businessName
                        });
                        var iw = new google.maps.InfoWindow({
                            content: '<strong>' + biz.businessName + '</strong><br>' + biz.address
                        });
                        marker.addListener('click', function() { iw.open(dashboardMap, marker); });
                    }
                });
            });
        }

        async function fetchBusinesses() {
            try {
                var res = await fetch('/api/businesses', { headers: { 'Authorization': 'Bearer ' + token } });
                if (res.status === 401) { logout(); return; }
                if (!res.ok) throw new Error('Failed');
                businessesData = await res.json();
                renderBusinessTable(businessesData);
                if (dashboardMap) addBusinessMarkers();
            } catch (err) {
                console.error(err);
                document.querySelector('#business-table tbody').innerHTML =
                    '<tr><td colspan="5" class="px-5 py-5 text-center text-red-500">砖 注转 转</td></tr>';
            }
        }

        function renderBusinessTable(businesses) {
            var tbody = document.querySelector('#business-table tbody');
            if (businesses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-5 py-5 text-center text-gray-500"> 爪 注住拽 注专转</td></tr>';
                return;
            }
            tbody.innerHTML = businesses.map(function(biz) {
                return '<tr class="hover:bg-gray-50">' +
                    '<td class="px-5 py-4 border-b border-gray-200 text-sm font-medium">' + biz.businessName + '</td>' +
                    '<td class="px-5 py-4 border-b border-gray-200 text-sm">' + biz.address + '</td>' +
                    '<td class="px-5 py-4 border-b border-gray-200 text-sm">' + biz.ownerName + '</td>' +
                    '<td class="px-5 py-4 border-b border-gray-200 text-sm">' + (biz.LicensingItem ? biz.LicensingItem.name : '-') + '</td>' +
                    '<td class="px-5 py-4 border-b border-gray-200 text-sm text-center">' +
                        '<a class="text-blue-600 hover:text-blue-900 ml-3" href="inspection.html?businessId=' + biz.id + '">拽专转 砖</a>' +
                        '<a class="text-green-600 hover:text-green-900" href="reports-history.html?businessId=' + biz.id + '">住专</a>' +
                    '</td>' +
                '</tr>';
            }).join('');
        }

        function filterBusinesses() {
            var filter = document.getElementById('search-input').value.toLowerCase();
            var filtered = businessesData.filter(function(b) { return b.businessName.toLowerCase().includes(filter); });
            renderBusinessTable(filtered);
        }

        fetchReports();
        fetchBusinesses();
        renderCalendar();
    </script>
</body>
</html>
