<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>פאנל ניהול | מערכת רישוי עסקים</title>
    <link rel="stylesheet" href="/tailwind.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col" dir="rtl">
    <header class="bg-white shadow-md px-6 py-3 flex justify-between items-center">
        <h1 class="text-xl font-bold text-gray-800">פאנל ניהול</h1>
        <div class="flex items-center gap-4">
            <nav class="flex gap-3">
                <a href="dashboard.html" class="px-4 py-2 bg-gray-100 border border-gray-300 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200 transition-colors">לוח בקרה</a>
                <a href="inspection.html" class="px-4 py-2 bg-gray-100 border border-gray-300 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200 transition-colors">ביקורת חדשה</a>
            </nav>
            <span id="user-name" class="text-gray-700 text-sm font-medium"></span>
            <button class="logout px-4 py-2 bg-red-500 text-white rounded-lg text-sm font-medium hover:bg-red-600 transition-colors" onclick="logout()">יציאה</button>
        </div>
    </header>

    <div class="container mx-auto px-4 py-8 flex-1 max-w-5xl" style="box-sizing:border-box;">
        <div class="bg-white rounded-lg shadow-md overflow-hidden mb-8">
            <div class="px-5 py-4 border-b border-gray-200 bg-gray-50">
                <h2 class="text-lg font-semibold text-gray-700">משתמשים הממתינים לאישור</h2>
            </div>
            <table id="pending-users-table" class="min-w-full leading-normal">
                <thead>
                    <tr>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">שם מלא</th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">אימייל</th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">תפקיד</th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">תאריך הרשמה</th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">פעולה</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="5" class="px-5 py-5 text-center text-gray-500">טוען נתונים...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <footer class="text-center py-4 bg-white border-t border-gray-200 text-gray-500 text-sm mt-auto">
        &copy; 2026 מערכת רישוי עסקים - מועצה אזורית. כל הזכויות שמורות.
    </footer>

    <script>
        const token = localStorage.getItem('token');
        const userStr = localStorage.getItem('user');
        let user;

        // Auth & Role Check
        if (!token || !userStr) {
            window.location.href = 'login.html';
        } else {
            user = JSON.parse(userStr);
            if (user.role !== 'admin') {
                alert('אין לך הרשאת גישה לדף זה.');
                window.location.href = 'dashboard.html';
            }
            document.getElementById('user-name').textContent = `שלום, ${user.fullName}`;
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }

        async function fetchPendingUsers() {
            const tbody = document.querySelector('#pending-users-table tbody');
            try {
                const response = await fetch('/api/admin/pending-users', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.status === 401 || response.status === 403) {
                    logout();
                    return;
                }

                const users = await response.json();
                tbody.innerHTML = '';

                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="px-5 py-5 text-center text-gray-500">אין משתמשים הממתינים לאישור.</td></tr>';
                    return;
                }

                users.forEach(pendingUser => {
                    const row = document.createElement('tr');
                    row.id = `user-row-${pendingUser.id}`;
                    row.className = 'hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="px-5 py-4 border-b border-gray-200 text-sm">${pendingUser.fullName}</td>
                        <td class="px-5 py-4 border-b border-gray-200 text-sm">${pendingUser.email}</td>
                        <td class="px-5 py-4 border-b border-gray-200 text-sm">${pendingUser.role}</td>
                        <td class="px-5 py-4 border-b border-gray-200 text-sm">${new Date(pendingUser.createdAt).toLocaleDateString('he-IL')}</td>
                        <td class="px-5 py-4 border-b border-gray-200 text-sm text-center">
                            <button class="approve-btn px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700 transition-colors mr-2" onclick="approveUser(${pendingUser.id})">אשר משתמש</button>
                            <button class="deny-btn px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600 transition-colors" onclick="denyUser(${pendingUser.id})">דחה</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

            } catch (error) {
                console.error('Error fetching pending users:', error);
                tbody.innerHTML = '<tr><td colspan="5" class="px-5 py-5 text-center text-red-500">שגיאה בטעינת המשתמשים.</td></tr>';
            }
        }

        async function approveUser(userId) {
            const button = document.querySelector(`#user-row-${userId} button`);
            button.disabled = true;
            button.textContent = 'מאשר...';

            try {
                const response = await fetch(`/api/admin/approve/${userId}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'שגיאה באישור המשתמש');
                }
                
                alert('המשתמש אושר בהצלחה!');
                document.getElementById(`user-row-${userId}`).remove();

                const tbody = document.querySelector('#pending-users-table tbody');
                if (tbody.children.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="px-5 py-5 text-center text-gray-500">אין משתמשים הממתינים לאישור.</td></tr>';
                }

            } catch (error) {
                console.error('Error approving user:', error);
                alert(`שגיאה: ${error.message}`);
                button.disabled = false;
                button.textContent = 'אשר משתמש';
            }
        }

        async function denyUser(userId) {
            if (!confirm('האם אתה בטוח שברצונך לדחות ולמחוק את המשתמש?')) return;

            const button = document.querySelector(`#user-row-${userId} .deny-btn`);
            button.disabled = true;
            button.textContent = '...';

            try {
                const response = await fetch(`/api/admin/deny/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'שגיאה בדחיית המשתמש');
                }
                
                alert('המשתמש נדחה ונמחק בהצלחה.');
                document.getElementById(`user-row-${userId}`).remove();

                const tbody = document.querySelector('#pending-users-table tbody');
                if (tbody.children.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="px-5 py-5 text-center text-gray-500">אין משתמשים הממתינים לאישור.</td></tr>';
                }

            } catch (error) {
                console.error('Error denying user:', error);
                alert(`שגיאה: ${error.message}`);
                button.disabled = false;
                button.textContent = 'דחה';
            }
        }

        // Initial Load
        fetchPendingUsers();
    </script>
</body>
</html>